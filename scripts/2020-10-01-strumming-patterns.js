var count=4,beatType=4,tempo="60",defaultL="1/16",measuresPerLine=2,down="↓",up="↑",strumPlaceholder="S",beats=[{pattern:"\"\u2193\"c2\"\"\"S\"c2",chord:"C"},{pattern:"\"\u2193\"c3\"\"\"\u2191\"c",chord:"C"},{pattern:"\"\u2193\"c\"\"\"\u2191\"c\"\"\"\u2193\"c2",chord:"D"},{pattern:"\"\u2193\"c2\"\"\"S\"c2",chord:"D"}],audioEnabled=false,displayOptions={displayLoop:true,displayRestart:true,displayPlay:true,displayProgress:true,displayWarp:true},audioOptions={chordsOff:true},blockPatterns=["\"\u2193\"c4","\"\u2193\"c2\"\"\"S\"c2","\"\u2193\"c\"\"\"\u2191\"c\"\"\"\u2193\"c\"\"\"\u2191\"c","\"\u2193\"c2\"\"\"\u2193\"c\"\"\"\u2191\"c","\"\u2193\"c\"\"\"\u2191\"c\"\"\"\u2193\"c2","\"\u2193\"c3\"\"\"\u2191\"c","\"\u2193\"c\"\"\"\u2191\"c3"],blocksSection=document.getElementById("blocks");for(var i=0;i<blockPatterns.length;i++){var pattern=blockPatterns[i].replaceAll('""',''),abc="X:"+(i+2)+"\nL: "+defaultL+"\nK: C treble style=rhythm\n"+pattern,blockId="block-"+i,blockHtml="<div class=\"block\">\n<div id=\""+blockId+"\" onclick=\"append("+i+")()\" ></div>\n<label>Leading tie <input type=\"checkbox\" id=\""+blockId+"-tie\"></label>\n</div>";blocksSection.innerHTML+=blockHtml;ABCJS.renderAbc(blockId,abc)};var usesSixteenths=function(){return beats.some(function(b){return b['pattern'].includes('"c"')})},updateEighths=function(){var blockId="block-1",eighthOffbeat=usesSixteenths()?down:up,pattern=blockPatterns[1].replace(strumPlaceholder,eighthOffbeat).replace('""',''),el=document.getElementById(blockId),abc="X:3\nL: "+defaultL+"\nK: C treble style=rhythm\n"+pattern;ABCJS.renderAbc(blockId,abc)},eventCallback=function(ev){document.querySelectorAll('.cursor-note').forEach(function(el){return el.classList.remove('cursor-note')});var elements=ev['elements'].forEach(function(el){return el[0].classList.add('cursor-note')})},updateMidi=function(tune){if(!document.getElementById("audioEnabled").checked){document.getElementById("audio").innerHTML="";return};if(ABCJS.synth.supportsAudio()){var synthControl=new ABCJS.synth.SynthController();synthControl.load("#audio",{onEvent:eventCallback},displayOptions)}else{document.getElementById("audio").innerHTML="Audio not supported in this browser";return};var synth=new ABCJS.synth.CreateSynth();synth.init({visualObj:tune}).then(function(){synthControl.setTune(tune,false,audioOptions).then(function(){return console.log("Audio loaded")})["catch"](function(error){return console.warn("Audio problem: ",error)})})["catch"](function(error){return console.warn("Audio problem during init: ",error)})},clearScore=function(){beats.length=0;update()},removeLastBeat=function(){beats.pop();update()},appendHelper=function(pattern,useTie,chord){if(useTie)pattern='-""'+pattern.substring(3);var beat={pattern:pattern,chord:chord};beats.push(beat);update()},append=function(i){return function(){var pattern=blockPatterns[i],useTie=document.getElementById("block-"+i+"-tie").checked,chord=getChord();appendHelper(pattern,useTie,chord)}},getCount=function(){return parseInt(document.getElementById("beatsPerMeasure").value)},getChord=function(){return document.getElementById('nextChord').value},getTitle=function(){return document.getElementById("title").value},getComposer=function(){return document.getElementById("composer").value},getKey=function(){return document.getElementById("key").value},buildAbc=function(){var title=getTitle(),composer=getComposer(),count=getCount(),key=getKey().replace(/(.+)#/,"^$1").replace(/(.+)b/,"_$1"),meter=count+"/"+beatType,abc="X: 1\nT: "+title+"\nC: "+composer+"\nL: "+defaultL+"\nK: "+key+" treble style=rhythm\nQ: 1/4="+tempo+"\nM: "+meter+"\n",linesWithChords=beats.reduce(function(d,beat,i){var line=Math.floor(i/(count*measuresPerLine));if(d['previousChord']!==beat['chord']){d[line]=true;d['previousChord']=beat['chord']};return d},{previousChord:null}),previousChord=null,currentLine=0,eighthOffbeat=usesSixteenths()?down:up;for(var i=1;i<=beats.length;i++){var beat=beats[i-1],chord=beat['chord'],pattern=beat['pattern'].replaceAll('c',chord[0]),line=Math.floor((i-1)/(count*measuresPerLine));pattern=line in linesWithChords?pattern:pattern.replaceAll('""','');if(previousChord===chord){if(line in linesWithChords)abc+='""'}else abc+="\""+chord+"\"";previousChord=chord;abc+=pattern.replace(strumPlaceholder,eighthOffbeat)+" ";if(i%count===0&&i!==beats.length)abc+="| ";if(i%(measuresPerLine*count)===0&&i!==beats.length){abc+="\n";currentLine++}};return abc+"|]"},updateMeasureView=function(){measuresPerLine=parseInt(document.getElementById("measuresPerLine").value);update()},checkCopyMeasure=function(measure){measure=parseInt(measure);var el=document.getElementById("copyMeasure"),totalMeasures=Math.floor(beats.length/count);if(measure<1){measure=1}else if(measure>totalMeasures)measure=Math.max(totalMeasures,1);el.value=measure;return measure-1},copyMeasure=function(){var copyMeasure=checkCopyMeasure(document.getElementById("copyMeasure").value),start=copyMeasure*count,end=Math.min(beats.length,start+count);for(var i=start;i<end;i++)beats.push(beats[i]);update()},rand=function(n){return Math.floor(Math.random()*n)},generateMeasure=function(){var count=getCount(),measureRemainder=count-(beats.length%count),chord=getChord();for(var i=0;i<measureRemainder;i++){var pattern=blockPatterns[rand(blockPatterns.length)],useTie=rand(11)<2;appendHelper(pattern,useTie,chord)};update()},generate=function(){clearScore();var chords=['G','G','G','G','D','D','D','D','C','C','C','C','G','G','G','G'];chords.forEach(function(chord){var pattern=blockPatterns[rand(blockPatterns.length)],useTie=rand(11)<2;appendHelper(pattern,useTie,chord)});document.getElementById('key').selectedIndex=15;update()},update=function(){var abc=buildAbc();document.getElementById("pattern-editor").innerHTML=abc;var tune=ABCJS.renderAbc("paper",abc,{responsive:"resize"})[0];updateEighths();updateMidi(tune)},share=function(){var beatShare=beats.reduceRight(function(p,b){return""+p+b['pattern'].replaceAll('"','q').replaceAll('↓','r').replaceAll('↑','t').replaceAll(' ','')+"u"+b['chord']+"n"},''),title=encodeURIComponent(getTitle()),composer=encodeURIComponent(getComposer()),count=getCount(),key=encodeURIComponent(getKey()),url=window.location.href.split('?')[0]+"?title="+title+"&composer="+composer+"&count="+count+"&key="+key+"&beats="+encodeURIComponent(beatShare),dummyArea=document.createElement("textarea");document.body.appendChild(dummyArea);dummyArea.value=url;dummyArea.select();document.execCommand("copy");document.body.removeChild(dummyArea);alert('Share URL copied to clipboard!')},parseShare=function(){var params=new URLSearchParams(window.location.search),beatsParam=params.get('beats');if(beatsParam){clearScore();new URLSearchParams(window.location.search).get('beats').split('n').forEach(function(patC){if(patC==='')return;var patCs=patC.split('u'),pat=patCs[0],chord=patCs[1];beats.push({chord:chord,pattern:pat.replaceAll('q','"').replaceAll('r','↓').replaceAll('t','↑')})});beats.reverse();if(params.get('title'))document.getElementById('title').value=decodeURIComponent(params.get('title'));if(params.get('composer'))document.getElementById('composer').value=decodeURIComponent(params.get('composer'));if(params.get('key'))document.getElementById('key').value=decodeURIComponent(params.get('key'));if(params.get('count'))document.getElementById('beatsPerMeasure').value=params.get('count')}};parseShare();update()